@model FrontEnd.Models.ProductListFilterViewModel

@{
    ViewData["Title"] = "Lista de Productos";
}


<div class="d-flex justify-content-between mb-3">
    <h2>Lista de Productos</h2>
    <button type="button" class="btn btn-personal-green btn-sm" data-bs-toggle="modal" data-bs-target="#createModal" title="Crear">
        <i class="bi bi-plus-circle"></i> Crear
    </button>
</div>
<!-- Formulario de búsqueda -->
<form method="get" asp-action="Index" asp-controller="Product" class="row mb-3">
    <div class="col-md-6">
        <input asp-for="Search" id="search" class="form-control" placeholder="Buscar producto..." />
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary">Buscar</button>
        <button type="button" onclick="cleanSearch()" class="btn btn-secondary">Limpiar</button>
    </div>
</form>

<!-- Mensaje de error -->
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Tabla de productos -->
<div id="productTableContainer">
    @await Html.PartialAsync("~/Views/Product/Partial/_ProductTable.cshtml", Model)
</div>
<!-- Paginación -->
@if (Model.Products != null && Model.Products.TotalPages > 1)
{
    <nav>
        <ul class="pagination justify-content-center">

            <!-- Botón Anterior -->
            <li class="page-item @(Model.Products.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-search="@Model.Search"
                   asp-route-page="@(Model.Products.CurrentPage - 1)">
                    Anterior
                </a>
            </li>

            <!-- Números de página -->
            @for (int i = 1; i <= Model.Products.TotalPages; i++)
            {
                <li class="page-item @(Model.Products.CurrentPage == i ? "active" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-search="@Model.Search"
                       asp-route-page="@i">
                        @i
                    </a>
                </li>
            }

            <!-- Botón Siguiente -->
            <li class="page-item @(Model.Products.CurrentPage == Model.Products.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-search="@Model.Search"
                   asp-route-page="@(Model.Products.CurrentPage + 1)">
                    Siguiente
                </a>
            </li>
        </ul>
    </nav>
}

<!-- Modal Crear -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Crear Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="createModalBody">

            </div>
        </div>
    </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editModalBody">

            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Eliminar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                ¿Estás seguro de eliminar este producto?
                <div class="mt-3 text-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="btnConfirmDelete" type="button" class="btn btn-danger">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        // Modal de edición
        var editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            const modalBody = editModal.querySelector('#editModalBody');

            modalBody.innerHTML = '<div class="text-center p-3">Cargando...</div>';

            fetch(`/Product/UpdatePartial?id=${id}`)
                .then(response => response.text())
                .then(html => {
                    modalBody.innerHTML = html;

                    const form = modalBody.querySelector('#updateForm');
                    form.addEventListener('submit', async function (e) {
                        e.preventDefault();

                        const formData = new FormData(form);
                        const response = await fetch(form.action, {
                            method: form.method,
                            body: formData
                        });

                        if (response.ok) {
                            bootstrap.Modal.getInstance(editModal).hide();
                            reloadTable();
                        } else {
                            alert('Error al actualizar el producto.');
                        }
                    });
                })
                .catch(() => {
                    modalBody.innerHTML = '<p class="text-danger">Error al cargar formulario.</p>';
                });
        });

            // Modal de creación
            var createModal = document.getElementById('createModal');
                    async function handleCreateForm() {
            const form = document.getElementById('createForm');
            if (!form) return;

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData
                });

                const text = await response.text();

                // Crea un elemento temporal para inspeccionar el HTML devuelto
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;

                // Si hay errores de validación, vuelve a renderizar el modal
                if (tempDiv.querySelector('.text-danger')) {
                    document.getElementById('createModalBody').innerHTML = text;
                    handleCreateForm(); // reengancha submit
                } else {
                    // Si no hay errores, cerrar modal y recargar tabla
                    bootstrap.Modal.getInstance(createModal).hide();
                    reloadTable();
                }
            });
        }


        // Cuando se abre el modal
        createModal.addEventListener('show.bs.modal', function () {
            const modalBody = createModal.querySelector('#createModalBody');
            modalBody.innerHTML = '<div class="text-center p-3">Cargando...</div>';

            fetch(`/Product/CreatePartial/`)
                .then(r => r.text())
                .then(html => {
                    modalBody.innerHTML = html;
                    handleCreateForm();
                })
                .catch(() => {
                    modalBody.innerHTML = '<p class="text-danger">Error al cargar formulario.</p>';
                });
        });


        // Confirmación de eliminación
        var deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const productId = button.getAttribute('data-id');
            const btnConfirmDelete = deleteModal.querySelector('#btnConfirmDelete');

            btnConfirmDelete.onclick = () => {
                fetch(`/Product/Delete/${productId}`, { method: 'DELETE' })
                    .then(r => {
                        if (r.ok) location.reload();
                        else alert('Error al eliminar');
                    });
            };
        });

        // Recargar tabla
        function reloadTable() {
            fetch('/Product/ProductTablePartial')
                .then(response => response.text())
                .then(html => document.getElementById('productTableContainer').innerHTML = html)
                .catch(() => alert('Error al recargar tabla.'));
        }


        function cleanSearch ()
        {
              document.getElementById("search").value = "";
              reloadTable()

        }
    </script>
}

